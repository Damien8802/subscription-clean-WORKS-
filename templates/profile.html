<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <title>Мой профиль - SaaSPro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; }
        .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 0; margin-bottom: 30px; }
        .profile-card { background: white; border-radius: 24px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
        .avatar-circle { width: 100px; height: 100px; background: linear-gradient(145deg, #667eea, #5a67d8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; margin-bottom: 20px; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
        .btn-save { background: #667eea; color: white; border-radius: 50px; padding: 10px 30px; border: none; }
        .btn-save:hover { background: #5a67d8; }
        @media (max-width: 768px) { .profile-header { padding: 30px 0; } .profile-card { padding: 20px; } }
    </style>
</head>
<body>
    <div class="profile-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2"><i class="fas fa-user-circle me-3"></i>Мой профиль</h1>
                <a href="/" class="btn btn-light rounded-pill"><i class="fas fa-arrow-left me-2"></i>На главную</a>
            </div>
        </div>
    </div>

    <div class="container">
        {{ if .User }}
        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="profile-card text-center">
                    <div class="avatar-circle mx-auto">
                        <span style="font-size: 2rem; font-weight: bold;">{{ .Initials }}</span>
                    </div>
                    <h4>{{ .User.Name }}</h4>
                    <p class="text-muted mb-1">{{ .User.Email }}</p>
                    <span class="badge bg-light text-dark px-3 py-2 mt-2">{{ .User.Role }}</span>
                    <hr class="my-4">
                    <div class="text-start small">
                        <p><i class="fas fa-calendar me-2 text-secondary"></i>Зарегистрирован: {{ .User.CreatedAt.Format "02.01.2006" }}</p>
                        <p><i class="fas fa-id-card me-2 text-secondary"></i>ID: {{ .User.ID }}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="profile-card">
                    <ul class="nav nav-tabs border-0 mb-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active bg-transparent border-0 px-4" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">Редактировать профиль</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link bg-transparent border-0 px-4" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">Сменить пароль</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="profileTabsContent">
                        <div class="tab-pane fade show active" id="edit" role="tabpanel">
                            <form id="profileForm">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Имя</label>
                                    <input type="text" class="form-control form-control-lg rounded-4" id="name" value="{{ .User.Name }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Email</label>
                                    <input type="email" class="form-control form-control-lg rounded-4" id="email" value="{{ .User.Email }}" required>
                                </div>
                                <button type="submit" class="btn btn-save mt-2">
                                    <i class="fas fa-save me-2"></i>Сохранить изменения
                                </button>
                                <div id="profileMessage" class="mt-3"></div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="password" role="tabpanel">
                            <form id="passwordForm">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Текущий пароль</label>
                                    <input type="password" class="form-control form-control-lg rounded-4" id="oldPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Новый пароль</label>
                                    <input type="password" class="form-control form-control-lg rounded-4" id="newPassword" required>
                                    <div class="form-text">Минимум 6 символов</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Подтвердите новый пароль</label>
                                    <input type="password" class="form-control form-control-lg rounded-4" id="confirmPassword" required>
                                </div>
                                <button type="submit" class="btn btn-save mt-2">
                                    <i class="fas fa-key me-2"></i>Изменить пароль
                                </button>
                                <div id="passwordMessage" class="mt-3"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{ else }}
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="profile-card text-center">
                    <div class="avatar-circle mx-auto">
                        <span style="font-size: 2rem; font-weight: bold;">?</span>
                    </div>
                    <h4 class="mt-3">Пользователь не найден</h4>
                    <p class="text-muted">{{ if .Error }}{{ .Error }}{{ else }}Войдите в систему, чтобы увидеть профиль.{{ end }}</p>
                    <a href="/login" class="btn btn-primary rounded-pill px-5 mt-3">Войти</a>
                </div>
            </div>
        </div>
        {{ end }}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        {{ if .User }}
        document.getElementById('profileForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });
                const result = await response.json();
                const msgDiv = document.getElementById('profileMessage');
                if (response.ok) {
                    msgDiv.innerHTML = '<div class="alert alert-success">Профиль обновлён!</div>';
                    setTimeout(() => location.reload(), 1500);
                } else {
                    msgDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + result.error + '</div>';
                }
            } catch (err) {
                document.getElementById('profileMessage').innerHTML = '<div class="alert alert-danger">Сетевая ошибка</div>';
            }
        });

        document.getElementById('passwordForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            if (newPassword !== confirm) {
                document.getElementById('passwordMessage').innerHTML = '<div class="alert alert-danger">Пароли не совпадают</div>';
                return;
            }
            try {
                const response = await fetch('/api/user/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });
                const result = await response.json();
                const msgDiv = document.getElementById('passwordMessage');
                if (response.ok) {
                    msgDiv.innerHTML = '<div class="alert alert-success">Пароль изменён!</div>';
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    msgDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + result.error + '</div>';
                }
            } catch (err) {
                document.getElementById('passwordMessage').innerHTML = '<div class="alert alert-danger">Сетевая ошибка</div>';
            }
        });
        {{ end }}
    </script>
</body>
</html>
