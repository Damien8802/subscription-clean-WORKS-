<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление API ключами</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .table { margin-top: 20px; }
        .badge-active { background: #4caf50; color: white; padding: 5px 10px; border-radius: 20px; }
        .badge-inactive { background: #f44336; color: white; padding: 5px 10px; border-radius: 20px; }
        .key-hash { font-family: monospace; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }
        .search-box { margin-bottom: 20px; }
        .pagination { justify-content: center; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-key me-3"></i> Управление API ключами</h1>
            <p class="mb-0">Всего ключей: <strong>{{ .Total }}</strong></p>
        </div>

        <div class="card">
            <!-- Поиск -->
            <div class="search-box">
                <form method="get" action="/admin/api-keys">
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Поиск по названию ключа или email пользователя" value="{{ .Search }}">
                        <button class="btn btn-primary" type="submit">Найти</button>
                    </div>
                </form>
            </div>

            <!-- Таблица ключей -->
            {{ if .Keys }}
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Название</th>
                        <th>Ключ (хеш)</th>
                        <th>Квота</th>
                        <th>Использовано</th>
                        <th>Статус</th>
                        <th>Создан</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .Keys }}
                    <tr id="key-{{ .ID }}">
                        <td>
                            <div><strong>{{ .UserName }}</strong></div>
                            <small class="text-muted">{{ .UserEmail }}</small>
                        </td>
                        <td>{{ .Name }}</td>
                        <td><span class="key-hash">{{ slice .KeyHash 0 20 }}...</span></td>
                        <td>
                            <input type="number" class="form-control form-control-sm quota-limit" 
                                   data-key-id="{{ .ID }}" value="{{ .QuotaLimit }}" style="width: 80px;">
                        </td>
                        <td>
                            <span class="badge {{ if gt .QuotaUsed .QuotaLimit }}bg-danger{{ else }}bg-info{{ end }}">
                                {{ .QuotaUsed }}
                            </span>
                        </td>
                        <td>
                            <select class="form-select form-select-sm status-select" data-key-id="{{ .ID }}" style="width: 100px;">
                                <option value="true" {{ if .IsActive }}selected{{ end }}>Активен</option>
                                <option value="false" {{ if not .IsActive }}selected{{ end }}>Заблокирован</option>
                            </select>
                        </td>
                        <td>{{ .CreatedAt }}</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-key" data-key-id="{{ .ID }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
            {{ else }}
            <p class="text-center text-muted py-4">Ключи не найдены</p>
            {{ end }}

            <!-- Пагинация -->
            {{ if gt .TotalPages 1 }}
            <nav>
                <ul class="pagination">
                    <li class="page-item {{ if eq .Page 1 }}disabled{{ end }}">
                        <a class="page-link" href="/admin/api-keys?page={{ sub .Page 1 }}&search={{ .Search }}">←</a>
                    </li>
                    {{ range $i := seq .TotalPages }}
                        {{ if or (eq $i $.Page) (and (ge $i (sub $.Page 2)) (le $i (add $.Page 2))) }}
                        <li class="page-item {{ if eq $i $.Page }}active{{ end }}">
                            <a class="page-link" href="/admin/api-keys?page={{ $i }}&search={{ $.Search }}">{{ $i }}</a>
                        </li>
                        {{ else if eq $i (add $.Page 3) }}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                        {{ end }}
                    {{ end }}
                    <li class="page-item {{ if eq .Page .TotalPages }}disabled{{ end }}">
                        <a class="page-link" href="/admin/api-keys?page={{ add .Page 1 }}&search={{ .Search }}">→</a>
                    </li>
                </ul>
            </nav>
            {{ end }}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-code.js" crossorigin="anonymous"></script>
    <script>
        // Обновление лимита
        document.querySelectorAll('.quota-limit').forEach(input => {
            input.addEventListener('change', async function() {
                const keyId = this.dataset.keyId;
                const newLimit = parseInt(this.value);
                
                try {
                    const response = await fetch(`/api/admin/api-keys/${keyId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quota_limit: newLimit })
                    });
                    
                    if (response.ok) {
                        alert('✅ Лимит обновлён');
                    } else {
                        alert('❌ Ошибка');
                    }
                } catch (e) {
                    alert('❌ Ошибка сети');
                }
            });
        });

        // Обновление статуса
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', async function() {
                const keyId = this.dataset.keyId;
                const isActive = this.value === 'true';
                
                try {
                    const response = await fetch(`/api/admin/api-keys/${keyId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_active: isActive })
                    });
                    
                    if (response.ok) {
                        alert('✅ Статус обновлён');
                    } else {
                        alert('❌ Ошибка');
                    }
                } catch (e) {
                    alert('❌ Ошибка сети');
                }
            });
        });

        // Удаление ключа
        document.querySelectorAll('.delete-key').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm('Удалить ключ? Это действие нельзя отменить.')) return;
                
                const keyId = this.dataset.keyId;
                
                try {
                    const response = await fetch(`/api/admin/api-keys/${keyId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        document.getElementById(`key-${keyId}`).remove();
                        alert('✅ Ключ удалён');
                    } else {
                        alert('❌ Ошибка');
                    }
                } catch (e) {
                    alert('❌ Ошибка сети');
                }
            });
        });
    </script>
</body>
</html>