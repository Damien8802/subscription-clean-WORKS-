import (
    "context"
    "net/http"
    "time"

    "github.com/gin-gonic/gin"
    "subscription-system/database"
)

func createReferralTables() error {
    // Таблица партнёрских программ
    _, err := Pool.Exec(context.Background(), `
        CREATE TABLE IF NOT EXISTS referral_programs (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE UNIQUE,
            referral_link TEXT NOT NULL,
            commission_percent INT NOT NULL DEFAULT 20,
            total_earned BIGINT DEFAULT 0,
            total_referred INT DEFAULT 0,
            created_at TIMESTAMP DEFAULT NOW(),
            updated_at TIMESTAMP DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS referral_commissions (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            referrer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
            referred_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
            amount BIGINT NOT NULL,
            status VARCHAR(20) DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT NOW(),
            paid_at TIMESTAMP
        );
        
        CREATE INDEX IF NOT EXISTS idx_referral_programs_user ON referral_programs(user_id);
        CREATE INDEX IF NOT EXISTS idx_referral_commissions_referrer ON referral_commissions(referrer_id);
        CREATE INDEX IF NOT EXISTS idx_referral_commissions_referred ON referral_commissions(referred_id);
    `)
    if err != nil {
        return err
    }
    log.Println("✅ Таблицы партнёрских программ готовы")
    return nil
}

