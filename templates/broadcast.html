package handlers

import (
    "fmt"
    "log"
    "net/http"
    "os"
    "strings"
    "time"

    "github.com/gin-gonic/gin"
    tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// BroadcastRequest - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
type BroadcastRequest struct {
    Type    string   `json:"type" binding:"required"` // "email", "sms", "telegram", "all"
    Subject string   `json:"subject"`                  // –¥–ª—è email
    Message string   `json:"message" binding:"required"`
    Users   []string `json:"users"`                    // —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –ø—É—Å—Ç–æ - —Ç–µ—Å—Ç–æ–≤—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º)
}

// EmailConfig –¥–ª—è SMTP
type EmailConfig struct {
    Host     string
    Port     string
    Username string
    Password string
    From     string
}

// BroadcastHandler - –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞—Å—Å—ã–ª–æ–∫
func BroadcastHandler(c *gin.Context) {
    var req BroadcastRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
    var recipients []string
    if len(req.Users) > 0 {
        recipients = req.Users
    } else {
        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
        log.Println("‚ÑπÔ∏è –°–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º")
        recipients = []string{
            "89182471690",          // –¢–≤–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è SMS
            "skorpion_88-88@mail.ru", // –¢–≤–æ–π email
            // "123456789",          // TODO: –¥–æ–±–∞–≤–∏—Ç—å —Ç–≤–æ–π Telegram chat_id, –∫–æ–≥–¥–∞ —É–∑–Ω–∞–µ—à—å
        }
    }

    results := make(map[string]interface{})

    switch req.Type {
    case "email":
        results = sendEmailBroadcast(recipients, req.Subject, req.Message)
    case "sms":
        results = sendSMSBroadcast(recipients, req.Message)
    case "telegram":
        results = sendTelegramBroadcast(recipients, req.Message)
    case "all":
        emailRes := sendEmailBroadcast(recipients, req.Subject, req.Message)
        smsRes := sendSMSBroadcast(recipients, req.Message)
        telegramRes := sendTelegramBroadcast(recipients, req.Message)
        results = gin.H{
            "email":    emailRes,
            "sms":      smsRes,
            "telegram": telegramRes,
        }
    default:
        c.JSON(http.StatusBadRequest, gin.H{"error": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ä–∞—Å—Å—ã–ª–∫–∏"})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "success": true,
        "results": results,
    })
}

// BroadcastPageHandler - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫
func BroadcastPageHandler(c *gin.Context) {
    c.HTML(http.StatusOK, "broadcast.html", gin.H{})
}

// ==================== EMAIL –†–ê–°–°–´–õ–ö–ê ====================
func sendEmailBroadcast(recipients []string, subject, message string) map[string]interface{} {
    cfg := EmailConfig{
        Host:     os.Getenv("SMTP_HOST"),
        Port:     os.Getenv("SMTP_PORT"),
        Username: os.Getenv("SMTP_USER"),
        Password: os.Getenv("SMTP_PASS"),
        From:     os.Getenv("SMTP_FROM"),
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ email-–∞–¥—Ä–µ—Å–∞ (—Å–æ–¥–µ—Ä–∂–∞—Ç '@')
    var emails []string
    for _, r := range recipients {
        if strings.Contains(r, "@") {
            emails = append(emails, r)
        }
    }

    if len(emails) == 0 {
        log.Println("üìß –ù–µ—Ç email-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
        return gin.H{"sent": 0, "message": "–ù–µ—Ç email-–∞–¥—Ä–µ—Å–æ–≤"}
    }

    if cfg.Host == "" || cfg.Port == "" {
        // –î–µ–º–æ-—Ä–µ–∂–∏–º
        log.Printf("üìß [DEMO] Email —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è %d –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: %s", len(emails), subject)
        return gin.H{
            "sent":    len(emails),
            "demo":    true,
            "first":   emails[0],
            "message": "DEMO: –ù–∞—Å—Ç—Ä–æ–π SMTP –≤ .env –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏",
        }
    }

    // TODO: –†–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ SMTP
    // –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

    return gin.H{
        "sent": len(emails),
        "via":  "smtp",
    }
}

// ==================== SMS –†–ê–°–°–´–õ–ö–ê ====================
func sendSMSBroadcast(recipients []string, message string) map[string]interface{} {
    apiKey := os.Getenv("SMS_API_KEY")

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å '+79' –∏–ª–∏ '89')
    var phones []string
    for _, r := range recipients {
        cleanNum := strings.TrimSpace(r)
        if strings.HasPrefix(cleanNum, "89") || strings.HasPrefix(cleanNum, "+79") {
            phones = append(phones, cleanNum)
        }
    }

    if len(phones) == 0 {
        log.Println("üì± –ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –¥–ª—è SMS-—Ä–∞—Å—Å—ã–ª–∫–∏")
        return gin.H{"sent": 0, "message": "–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤"}
    }

    if apiKey == "" {
        // –î–µ–º–æ-—Ä–µ–∂–∏–º
        log.Printf("üì± [DEMO] SMS —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è %d –Ω–æ–º–µ—Ä–æ–≤", len(phones))
        return gin.H{
            "sent":    len(phones),
            "demo":    true,
            "first":   phones[0],
            "message": "DEMO: –ù–∞—Å—Ç—Ä–æ–π SMS_API_KEY –≤ .env –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏",
        }
    }

    // TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SMS-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º (sms.ru, smsc.ru –∏ —Ç.–¥.)
    // for _, phone := range phones {
    //     // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ API
    // }

    return gin.H{
        "sent": len(phones),
        "via":  "sms-provider",
    }
}

// ==================== TELEGRAM –†–ê–°–°–´–õ–ö–ê ====================
func sendTelegramBroadcast(recipients []string, message string) map[string]interface{} {
    botToken := os.Getenv("TELEGRAM_BOT_TOKEN")

    // TODO: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è chat_id. –ü–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ - —ç—Ç–æ —á–∏—Å–ª–∞ (chat_id)
    var chatIDs []string
    for _, r := range recipients {
        // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –Ω–µ email –∏ –Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω
        if !strings.Contains(r, "@") && !strings.HasPrefix(r, "89") && !strings.HasPrefix(r, "+79") {
            chatIDs = append(chatIDs, r)
        }
    }

    if len(chatIDs) == 0 {
        log.Println("ü§ñ –ù–µ—Ç Telegram chat_id –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏")
        return gin.H{"sent": 0, "message": "–ù–µ—Ç Telegram chat_id"}
    }

    if botToken == "" {
        log.Printf("ü§ñ [DEMO] Telegram —Ä–∞—Å—Å—ã–ª–∫–∞ –¥–ª—è %d —á–∞—Ç–æ–≤", len(chatIDs))
        return gin.H{
            "sent":    len(chatIDs),
            "demo":    true,
            "first":   chatIDs[0],
            "message": "DEMO: –ü—Ä–æ–≤–µ—Ä—å TELEGRAM_BOT_TOKEN –≤ .env",
        }
    }

    bot, err := tgbotapi.NewBotAPI(botToken)
    if err != nil {
        log.Printf("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–æ—Ç—É: %v", err)
        return gin.H{
            "error": err.Error(),
            "sent":  0,
        }
    }

    sent := 0
    failed := 0

    for _, chatIDStr := range chatIDs {
        var chatID int64
        fmt.Sscanf(chatIDStr, "%d", &chatID)
        if chatID == 0 {
            log.Printf("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π chat_id: %s", chatIDStr)
            failed++
            continue
        }

        msg := tgbotapi.NewMessage(chatID, message)
        msg.ParseMode = "HTML"

        _, err := bot.Send(msg)
        if err != nil {
            log.Printf("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ %d: %v", chatID, err)
            failed++
        } else {
            sent++
        }

        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
        time.Sleep(100 * time.Millisecond)
    }

    return gin.H{
        "sent":   sent,
        "failed": failed,
    }
}