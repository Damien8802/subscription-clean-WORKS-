<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* –≤—Å–µ —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π - —è –∏—Ö –Ω–µ —Ç—Ä–æ–≥–∞—é, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(-45deg, rgba(190, 220, 255, 0.6), rgba(210, 190, 255, 0.6), rgba(255, 210, 240, 0.6), rgba(200, 230, 255, 0.6));
            background-size: 400% 400%;
            animation: gradient 20s ease infinite;
            color: var(--tg-theme-text-color, #222);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 100vh; padding: 16px; margin: 0;
        }
        @keyframes gradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .chat-container {
            background: rgba(255,255,255,0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 28px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 480px; width: 100%; margin: 0 auto 20px; border: 1px solid rgba(255,255,255,0.3);
            flex: 1; display: flex; flex-direction: column; max-height: 70vh;
        }
        .messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 16px; margin-bottom: 10px; }
        .message-wrapper { display: flex; align-items: flex-end; gap: 8px; }
        .message-wrapper.user { flex-direction: row-reverse; }
        .avatar {
            width: 32px; height: 32px; border-radius: 50%; background: var(--tg-theme-button-color, #2481cc);
            display: flex; align-items: center; justify-content: center; font-size: 18px;
            flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); animation: scaleIn 0.3s ease;
        }
        .avatar.bot { background: var(--tg-theme-hint-color, #999); }
        .message {
            padding: 12px 16px; border-radius: 18px; max-width: 70%; word-wrap: break-word;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .message.user { background: var(--tg-theme-button-color, #2481cc); color: white; border-bottom-right-radius: 4px; animation: slideInRight 0.4s cubic-bezier(0.21,1.11,0.42,1.11); }
        .message.assistant { background: var(--tg-theme-bg-color, #e9eef2); color: var(--tg-theme-text-color, #222); border-bottom-left-radius: 4px; animation: slideInLeft 0.4s cubic-bezier(0.21,1.11,0.42,1.11); }
        .timestamp { font-size: 10px; opacity: 0.6; margin-top: 4px; text-align: right; }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; background: var(--tg-theme-bg-color, #e9eef2); border-radius: 18px; border-bottom-left-radius: 4px; max-width: fit-content; animation: fadeIn 0.3s ease; }
        .typing-indicator span { width: 8px; height: 8px; background: var(--tg-theme-hint-color, #999); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay:0.2s; } .typing-indicator span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,60%,100% { transform:translateY(0); opacity:0.4; } 30% { transform:translateY(-8px); opacity:1; } }
        .input-area { display: flex; align-items: center; gap: 8px; margin-top: 10px; width: 100%; }
        .mic-button {
            background: var(--tg-theme-button-color, linear-gradient(145deg, #2481cc, #1a6bb0));
            color: white; border: none; border-radius: 50%; width: 48px; height: 48px;
            font-size: 22px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .mic-button.listening { background: linear-gradient(145deg, #ff5252, #ff1744); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform:scale(1); box-shadow:0 4px 12px rgba(255,82,82,0.4); } 50% { transform:scale(1.05); box-shadow:0 8px 24px rgba(255,82,82,0.6); } 100% { transform:scale(1); box-shadow:0 4px 12px rgba(255,82,82,0.4); } }
        .button-group { display: flex; gap: 8px; flex-shrink: 0; }
        .icon-button {
            background: var(--tg-theme-button-color, linear-gradient(145deg, #2481cc, #1a6bb0));
            color: white; border: none; border-radius: 50%; width: 48px; height: 48px;
            font-size: 22px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .icon-button.clear { background: linear-gradient(145deg, #ff7b7b, #ff5252); }
        input {
            flex: 1; padding: 14px 18px; border: none; border-radius: 30px;
            background: var(--tg-theme-bg-color, white); color: var(--tg-theme-text-color, #222);
            font-size: 16px; outline: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s; min-width: 0;
        }
        input:focus { box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        .profile-card {
            background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-radius: 20px;
            padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.2);
            width: 100%; max-width: 480px;
        }
        .profile-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .profile-info { display: flex; flex-wrap: wrap; gap: 8px; font-size: 14px; flex: 1; }
        .profile-info span { background: rgba(255,255,255,0.5); padding: 6px 12px; border-radius: 20px; }
        #userSubscription { background: transparent; padding: 6px 0; color: var(--tg-theme-hint-color, #666); font-weight: 500; width: 100%; }
        .subscribe-button {
            background: var(--tg-theme-button-color, linear-gradient(145deg, #2481cc, #1a6bb0));
            color: white; border: none; border-radius: 24px; padding: 10px 20px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: inline-flex; align-items: center; gap: 6px;
            text-decoration: none; white-space: nowrap;
        }
        .subscribe-button:hover { transform: scale(1.02); }
        .subscribe-button:active { transform: scale(0.98); }
        .token-stats { margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 16px; display: flex; flex-direction: column; gap: 8px; }
        .stat-item { display: flex; justify-content: space-between; font-size: 14px; }
        .stat-label { color: var(--tg-theme-hint-color, #666); }
        .stat-value { font-weight: 600; }
        .progress-mini { height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .progress-mini-fill { height: 100%; background: var(--tg-theme-button-color, #2481cc); width: 0%; transition: width 0.3s; }
        .docs-section { margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.02); border-radius: 16px; }
        .docs-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .docs-header h4 { font-size: 14px; color: var(--tg-theme-hint-color, #666); margin: 0; }
        .docs-list { max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .doc-item { background: var(--tg-theme-bg-color, rgba(255,255,255,0.5)); border-radius: 12px; padding: 8px 12px; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 13px; }
        .doc-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .doc-delete { background: transparent; border: none; color: #ff5252; cursor: pointer; font-size: 16px; }
        .upload-btn { background: var(--tg-theme-button-color, #2481cc); color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .model-selector { margin: 12px 0 0; padding: 8px 12px; background: rgba(0,0,0,0.02); border-radius: 16px; display: flex; align-items: center; gap: 10px; }
        .model-selector label { font-size: 14px; color: var(--tg-theme-hint-color, #666); white-space: nowrap; }
        .model-selector select { flex: 1; background: var(--tg-theme-bg-color, white); border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; padding: 8px 12px; font-size: 14px; color: var(--tg-theme-text-color, #222); outline: none; cursor: pointer; }
        .theme-toggle, .lang-toggle, .install-btn {
            background: transparent; border: none; font-size: 22px; cursor: pointer;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.2s;
        }
        .theme-toggle:hover, .lang-toggle:hover, .install-btn:hover { background: rgba(0,0,0,0.05); }
        .install-btn { font-size: 24px; }
        body.theme-light {
            --tg-theme-bg-color: #f5f5f5;
            --tg-theme-text-color: #222222;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #ffffff;
        }
        body.theme-dark {
            --tg-theme-bg-color: #1a1a1a;
            --tg-theme-text-color: #e0e0e0;
            --tg-theme-hint-color: #666666;
            --tg-theme-link-color: #bb86fc;
            --tg-theme-button-color: #bb86fc;
            --tg-theme-button-text-color: #000000;
            --tg-theme-secondary-bg-color: #2d2d2d;
        }
        body.theme-dark .chat-container, body.theme-dark .profile-card {
            background: rgba(30,30,30,0.85);
            border-color: rgba(255,255,255,0.1);
        }
        body.theme-dark .message.assistant {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        body.theme-dark input {
            background: #2d2d2d;
            color: #e0e0e0;
        }
        .toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; max-width: 90%; width: auto;
        }
        .toast {
            background: var(--tg-theme-button-color, #2481cc); color: white;
            padding: 12px 20px 12px 16px; border-radius: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); font-size: 14px;
            display: flex; align-items: center; gap: 10px;
            animation: slideDown 0.3s ease; pointer-events: auto; max-width: 400px;
        }
        .toast.success { background: #4caf50; }
        .toast.error { background: #ff5252; }
        .toast.warning { background: #ff9800; }
        .toast.info { background: #2481cc; }
        .toast-icon { font-size: 18px; }
        .toast-close {
            background: transparent; border: none; color: white; font-size: 18px;
            cursor: pointer; opacity: 0.7; margin-left: auto; padding: 0 4px;
        }
        .toast-close:hover { opacity: 1; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast.fade-out { animation: fadeOut 0.3s ease forwards; }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .progress-bar {
            position: relative; height: 4px; background: rgba(0,0,0,0.05);
            border-radius: 2px; margin: 8px 20px 0; overflow: hidden; display: none;
        }
        .progress-bar.active { display: block; }
        .progress-bar-fill {
            position: absolute; top: 0; left: 0; height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--tg-theme-button-color, #2481cc), #8a6de9);
            border-radius: 2px; animation: progress 30s linear forwards;
        }
        @keyframes progress { 0% { width:0%; } 100% { width:100%; } }
        .copy-btn {
            background:transparent; border:none; font-size:16px; cursor:pointer;
            opacity:0.5; transition:opacity 0.2s; margin-left:8px;
        }
        .copy-btn:hover { opacity:1; }
        .reactions {
            display:flex; gap:8px; margin-top:4px; justify-content:flex-end;
            opacity:0; transition:opacity 0.2s;
        }
        .message-wrapper.assistant:hover .reactions { opacity:1; }
        .reaction-btn {
            background:transparent; border:none; font-size:16px; cursor:pointer;
            display:flex; align-items:center; gap:4px;
        }
        .reaction-count { font-size:14px; color:#666; }
        .messages::-webkit-scrollbar { width:6px; }
        .messages::-webkit-scrollbar-track { background:transparent; }
        .messages::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.2); border-radius:10px; }
        .messages { scrollbar-width:thin; scrollbar-color:rgba(0,0,0,0.2) transparent; }
        .admin-panel { margin-top:20px; border-top:1px solid rgba(0,0,0,0.1); padding-top:16px; }
        .admin-tabs { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
        .admin-tab {
            background: rgba(0,0,0,0.05); border:none; border-radius:20px;
            padding:8px 16px; font-size:14px; cursor:pointer;
        }
        .admin-tab.active { background: var(--tg-theme-button-color,#2481cc); color:white; }
        .admin-section { display:none; }
        .admin-section.active { display:block; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(2,1fr); gap:12px; margin-bottom:16px;
        }
        .stat-card {
            background: rgba(0,0,0,0.03); border-radius:16px; padding:12px; text-align:center;
        }
        .stat-value { font-size:24px; font-weight:700; color: var(--tg-theme-button-color,#2481cc); }
        .stat-label { font-size:12px; color: var(--tg-theme-hint-color,#666); }
        .users-table { width:100%; border-collapse:collapse; font-size:13px; }
        .users-table th { text-align:left; padding:8px 4px; color:#666; font-weight:500; }
        .users-table td { padding:8px 4px; border-bottom:1px solid rgba(0,0,0,0.05); }
        .block-btn { background:#ff5252; color:white; border:none; border-radius:12px; padding:4px 8px; font-size:12px; cursor:pointer; }
        .unblock-btn { background:#4caf50; color:white; border:none; border-radius:12px; padding:4px 8px; font-size:12px; cursor:pointer; }
        .plans-list { display:flex; flex-direction:column; gap:8px; }
        .plan-item {
            background: rgba(0,0,0,0.03); border-radius:16px; padding:12px;
            display:flex; align-items:center; justify-content:space-between;
        }
        .plan-info h4 { margin:0 0 4px; font-size:16px; }
        .plan-info p { margin:0; font-size:12px; color:#666; }
        .plan-actions button {
            background:#ff5252; color:white; border:none; border-radius:12px;
            padding:6px 12px; font-size:12px; cursor:pointer; margin-left:8px;
        }
        .plan-actions .edit-plan { background:#4caf50; }
        .modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;
        }
        .modal.active { display:flex; }
        .modal-content {
            background: white; border-radius:28px; padding:24px; max-width:400px;
            width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-top:0; margin-bottom:20px; font-size:1.4rem; }
        .form-group { margin-bottom:16px; }
        .form-group label {
            display:block; margin-bottom:6px; font-size:14px; color:#666;
        }
        .form-group input, .form-group textarea {
            width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:16px;
            font-size:14px;
        }
        .form-row { display:flex; gap:12px; }
        .form-row .form-group { flex:1; }
        .modal-buttons { display:flex; gap:10px; margin-top:20px; }
        .modal-buttons button {
            flex:1; padding:12px; border:none; border-radius:24px; font-size:16px;
            font-weight:600; cursor:pointer;
        }
        .save-btn { background:#2481cc; color:white; }
        .cancel-btn { background:#f0f0f0; }
        .stats-tab { margin-top:16px; }
        .stats-controls { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
        .stats-btn {
            background:rgba(0,0,0,0.05); border:none; border-radius:20px;
            padding:8px 16px; font-size:14px; cursor:pointer;
        }
        .stats-btn.active { background:#2481cc; color:white; }
        .chart-container { position:relative; height:200px; width:100%; margin:10px 0; }
        @media (min-width:600px) {
            .chat-container, .profile-card { max-width:800px; }
            .message { max-width:80%; }
        }
        @media (min-width:1024px) {
            .chat-container, .profile-card { max-width:900px; }
            .message { max-width:70%; }
        }
        @media (orientation:landscape) and (max-height:600px) {
            .chat-container { max-height:85vh; }
            .messages { max-height:60vh; }
        }
    </style>
</head>
<body>
    <div class="profile-card" id="profileCard" style="display: none;">
        <div class="profile-header">
            <div class="profile-info">
                <span id="userEmail"></span>
                <span id="userRole"></span>
            </div>
            <a href="https://t.me/AgentServer_bot?start=plans" target="_blank" class="subscribe-button" id="subscribeBtn">‚≠ê <span data-i18n="buy_subscription">–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span></a>
            <button class="lang-toggle" id="langToggle" title="Switch language">üá¨üáß</button>
            <!-- –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–Ω–∞ –≤—Å–µ–≥–¥–∞, –Ω–æ –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç–∞, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ -->
            <button class="install-btn" id="installBtn" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ">üì≤</button>
            <button class="theme-toggle" id="adminPanelBtn" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" style="display: none;">üëë</button>
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì</button>
        </div>
        <div id="userSubscription" style="margin-bottom: 10px;"></div>
        <div class="token-stats" id="tokenStats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label" data-i18n="tokens_used">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤</span>
                <span class="stat-value" id="tokensUsed">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" data-i18n="tokens_limit">–õ–∏–º–∏—Ç</span>
                <span class="stat-value" id="tokensLimit">‚Äî</span>
            </div>
            <div class="progress-mini">
                <div class="progress-mini-fill" id="tokenProgress" style="width: 0%;"></div>
            </div>
        </div>
        <div class="docs-section" id="docsSection" style="display: none;">
            <div class="docs-header">
                <h4 data-i18n="my_documents">üìö –ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h4>
                <label class="upload-btn" for="docUpload"><span data-i18n="upload">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å</span></label>
                <input type="file" id="docUpload" accept=".txt,.pdf" style="display: none;">
            </div>
            <div class="docs-list" id="docsList"></div>
        </div>
        <div class="model-selector" id="modelSelector" style="display: none;">
            <label data-i18n="model">–ú–æ–¥–µ–ª—å:</label>
            <select id="modelSelect">
                <option value="yandex/yandexgpt-lite">YandexGPT Lite</option>
                <option value="gigachat/gigachat-max">GigaChat Max</option>
                <option value="openai/gpt-4.1-mini">GPT-4.1 Mini</option>
                <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                <option value="ollama/llama3.2">Llama 3.2</option>
            </select>
        </div>
        <div class="stats-tab" id="statsTab" style="display: none;">
            <h4 data-i18n="token_usage_stats">üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤</h4>
            <div class="stats-controls">
                <button class="stats-btn active" data-period="week" data-i18n="week">–ù–µ–¥–µ–ª—è</button>
                <button class="stats-btn" data-period="month" data-i18n="month">–ú–µ—Å—è—Ü</button>
                <button class="stats-btn" data-period="year" data-i18n="year">–ì–æ–¥</button>
            </div>
            <div class="chart-container">
                <canvas id="tokenChart"></canvas>
            </div>
        </div>
        <div class="admin-panel" id="adminPanel" style="display: none;">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="stats" data-i18n="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="admin-tab" data-tab="users" data-i18n="users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="admin-tab" data-tab="plans" data-i18n="plans">üìã –¢–∞—Ä–∏—Ñ—ã</button>
            </div>
            <div class="admin-section active" id="statsSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label" data-i18n="total_users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeSubs">0</div>
                        <div class="stat-label" data-i18n="active_subs">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalAI">0</div>
                        <div class="stat-label" data-i18n="total_ai">AI-–∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalKeys">0</div>
                        <div class="stat-label" data-i18n="total_keys">API-–∫–ª—é—á–µ–π</div>
                    </div>
                </div>
            </div>
            <div class="admin-section" id="usersSection">
                <table class="users-table">
                    <thead><tr><th data-i18n="email">Email</th><th data-i18n="role">–†–æ–ª—å</th><th data-i18n="status">–°—Ç–∞—Ç—É—Å</th><th data-i18n="action">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                    <tbody id="usersList"></tbody>
                </table>
            </div>
            <div class="admin-section" id="plansSection">
                <div class="plans-list" id="plansList"></div>
            </div>
        </div>
    </div>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="progress-bar" id="progressBar">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
        <div class="input-area">
            <input type="text" id="questionInput" placeholder="" disabled>
            <button class="mic-button" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥" disabled>üé§</button>
            <div class="button-group">
                <button class="icon-button" id="sendBtn" disabled>‚úàÔ∏è</button>
                <button class="icon-button clear" id="clearBtn">üßπ</button>
            </div>
        </div>
    </div>
    <div id="loading" class="spinner" style="display: none;"></div>
    <div class="modal" id="planModal">
        <div class="modal-content">
            <h3 id="modalTitle" data-i18n="create_plan">–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞</h3>
            <form id="planForm">
                <div class="form-group">
                    <label data-i18n="plan_name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="planName" required>
                </div>
                <div class="form-group">
                    <label data-i18n="plan_code">–ö–æ–¥</label>
                    <input type="text" id="planCode" required>
                </div>
                <div class="form-group">
                    <label data-i18n="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="planDescription" rows="2"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="price_monthly">–¶–µ–Ω–∞ –≤ –º–µ—Å—è—Ü (‚ÇΩ)</label>
                        <input type="number" id="planPriceMonthly" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="price_yearly">–¶–µ–Ω–∞ –≤ –≥–æ–¥ (‚ÇΩ)</label>
                        <input type="number" id="planPriceYearly" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label data-i18n="currency">–í–∞–ª—é—Ç–∞</label>
                    <input type="text" id="planCurrency" value="RUB" required>
                </div>
                <div class="form-group">
                    <label data-i18n="ai_quota">AI-–∫–≤–æ—Ç–∞ (—Ç–æ–∫–µ–Ω–æ–≤)</label>
                    <input type="number" id="planAIQuota" value="1000000" required>
                </div>
                <div class="form-group">
                    <label data-i18n="ai_models">–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏</label>
                    <input type="text" id="planAIModels" value="*" required>
                </div>
                <div class="form-group">
                    <label data-i18n="is_active">–ê–∫—Ç–∏–≤–µ–Ω</label>
                    <input type="checkbox" id="planIsActive" checked>
                </div>
                <input type="hidden" id="planId">
            </form>
            <div class="modal-buttons">
                <button class="save-btn" id="savePlanBtn" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="cancel-btn" id="cancelPlanBtn" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script>
        // ---------- –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å ----------
        const translations = {
            ru: {
                buy_subscription: "–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É",
                tokens_used: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤",
                tokens_limit: "–õ–∏–º–∏—Ç",
                my_documents: "üìö –ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã",
                upload: "üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å",
                model: "–ú–æ–¥–µ–ª—å:",
                token_usage_stats: "üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤",
                week: "–ù–µ–¥–µ–ª—è",
                month: "–ú–µ—Å—è—Ü",
                year: "–ì–æ–¥",
                stats: "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                users: "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
                plans: "üìã –¢–∞—Ä–∏—Ñ—ã",
                total_users: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
                active_subs: "–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫",
                total_ai: "AI-–∑–∞–ø—Ä–æ—Å–æ–≤",
                total_keys: "API-–∫–ª—é—á–µ–π",
                email: "Email",
                role: "–†–æ–ª—å",
                status: "–°—Ç–∞—Ç—É—Å",
                action: "–î–µ–π—Å—Ç–≤–∏–µ",
                create_plan: "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞",
                plan_name: "–ù–∞–∑–≤–∞–Ω–∏–µ",
                plan_code: "–ö–æ–¥",
                description: "–û–ø–∏—Å–∞–Ω–∏–µ",
                price_monthly: "–¶–µ–Ω–∞ –≤ –º–µ—Å—è—Ü (‚ÇΩ)",
                price_yearly: "–¶–µ–Ω–∞ –≤ –≥–æ–¥ (‚ÇΩ)",
                currency: "–í–∞–ª—é—Ç–∞",
                ai_quota: "AI-–∫–≤–æ—Ç–∞ (—Ç–æ–∫–µ–Ω–æ–≤)",
                ai_models: "–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏",
                is_active: "–ê–∫—Ç–∏–≤–µ–Ω",
                save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                cancel: "–û—Ç–º–µ–Ω–∞",
                input_placeholder: "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...",
                voice_input_title: "–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥",
                clear_chat: "–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç",
                no_active_subscription: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏",
                subscription_active: "–ü–æ–¥–ø–∏—Å–∫–∞: –∞–∫—Ç–∏–≤–Ω–∞",
                auth_error: "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏",
                copy_error: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç",
                mic_denied: "–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω",
                mic_not_supported: "–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è",
                upload_success: "–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω",
                upload_error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",
                delete_confirm: "–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?",
                delete_success: "–î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª—ë–Ω",
                plan_saved: "–¢–∞—Ä–∏—Ñ —Å–æ—Ö—Ä–∞–Ω—ë–Ω",
                plan_deleted: "–¢–∞—Ä–∏—Ñ —É–¥–∞–ª—ë–Ω",
                plan_delete_confirm: "–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?",
                install_unavailable: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞.",
            },
            en: {
                buy_subscription: "Buy subscription",
                tokens_used: "Tokens used",
                tokens_limit: "Limit",
                my_documents: "üìö My documents",
                upload: "üìé Upload",
                model: "Model:",
                token_usage_stats: "üìà Token usage",
                week: "Week",
                month: "Month",
                year: "Year",
                stats: "üìä Statistics",
                users: "üë• Users",
                plans: "üìã Plans",
                total_users: "Total users",
                active_subs: "Active subscriptions",
                total_ai: "AI requests",
                total_keys: "API keys",
                email: "Email",
                role: "Role",
                status: "Status",
                action: "Action",
                create_plan: "Create plan",
                plan_name: "Name",
                plan_code: "Code",
                description: "Description",
                price_monthly: "Monthly price (‚ÇΩ)",
                price_yearly: "Yearly price (‚ÇΩ)",
                currency: "Currency",
                ai_quota: "AI quota (tokens)",
                ai_models: "Allowed models",
                is_active: "Active",
                save: "Save",
                cancel: "Cancel",
                input_placeholder: "Type your question...",
                voice_input_title: "Voice input",
                clear_chat: "Clear chat",
                no_active_subscription: "No active subscription",
                subscription_active: "Subscription: active",
                auth_error: "Authorization error",
                copy_error: "Failed to copy text",
                mic_denied: "Microphone access denied",
                mic_not_supported: "Voice input not supported",
                upload_success: "Document uploaded",
                upload_error: "Upload error",
                delete_confirm: "Delete document?",
                delete_success: "Document deleted",
                plan_saved: "Plan saved",
                plan_deleted: "Plan deleted",
                plan_delete_confirm: "Delete plan?",
                install_unavailable: "Installation not available now. Try later or use browser menu.",
            }
        };
        let currentLang = localStorage.getItem('lang') || 'ru';
        function t(key) { return translations[currentLang][key] || key; }
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); el.textContent = t(key); });
            document.getElementById('questionInput').placeholder = t('input_placeholder');
            document.getElementById('micBtn').title = t('voice_input_title');
            document.getElementById('clearBtn').title = t('clear_chat');
        }
        function toggleLang() {
            currentLang = currentLang === 'ru' ? 'en' : 'ru';
            localStorage.setItem('lang', currentLang);
            document.getElementById('langToggle').textContent = currentLang === 'ru' ? 'üá¨üáß' : 'üá∑üá∫';
            applyLanguage();
            if (user) {
                document.getElementById('userSubscription').textContent = user.subscription ? t('subscription_active') : t('no_active_subscription');
            }
        }
        document.getElementById('langToggle').addEventListener('click', toggleLang);
        applyLanguage();
        document.getElementById('langToggle').textContent = currentLang === 'ru' ? 'üá¨üáß' : 'üá∑üá∫';
        // ---------- PWA ----------
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // –ö–Ω–æ–ø–∫–∞ —É–∂–µ –≤–∏–¥–Ω–∞, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installBtn').style.display = 'none';
            deferredPrompt = null;
        });

        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
            document.getElementById('installBtn').style.display = 'none';
        }

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            } else {
                showToast(t('install_unavailable'), 'warning');
            }
        });
        // ---------- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ ----------
        let tg = window.Telegram.WebApp; tg.expand(); tg.ready();
        const initData = tg.initData;
        let user = null;
        let tokenChart = null;
        let editingPlanId = null;
        async function loadProfile() {
            try {
                const response = await fetch('/api/webapp/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({initData}) });
                if (!response.ok) throw new Error('Auth failed');
                const data = await response.json();
                user = data.user;
                window.userName = user.name || '';
                document.getElementById('userEmail').textContent = user.email || '‚Äî';
                document.getElementById('userRole').textContent = t('role') + ': ' + (user.role || '‚Äî');
                document.getElementById('userSubscription').textContent = data.subscription ? t('subscription_active') : t('no_active_subscription');
                document.getElementById('profileCard').style.display = 'block';
                document.getElementById('questionInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('micBtn').disabled = false;
                if (user.role === 'admin') {
                    document.getElementById('adminPanelBtn').style.display = '';
                }
                await loadHistory();
                await loadTokenUsage();
                await loadDocs();
                document.getElementById('statsTab').style.display = 'block';
                updateChart('week');
            } catch(e){ console.error(e); showToast(t('auth_error'), 'error'); }
        }
        async function loadHistory() {
            if (!user) return;
            try {
                const response = await fetch(`/api/chat/history?user_id=${user.id}`);
                if (!response.ok) throw new Error('Failed to load history');
                const data = await response.json();
                document.getElementById('messages').innerHTML = '';
                for (const msg of data.history) addMessage(msg.content, msg.role, false);
                if (data.history.length === 0) addMessage('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å.', 'assistant', false);
            } catch(e){ console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', e); }
        }
        async function loadTokenUsage() {
            if (!user) return;
            try {
                const response = await fetch('/api/user/ai-usage', { headers: { 'Authorization': 'Bearer ' + user.id } });
                if (!response.ok) throw new Error('Failed to load usage');
                const data = await response.json();
                if (data.keys && data.keys.length > 0) {
                    const key = data.keys[0];
                    document.getElementById('tokensUsed').textContent = key.quota_used;
                    if (key.quota_limit === -1) {
                        document.getElementById('tokensLimit').textContent = '‚àû';
                        document.getElementById('tokenStats').style.display = 'none';
                    } else {
                        document.getElementById('tokensLimit').textContent = key.quota_limit;
                        const percent = (key.quota_used / key.quota_limit) * 100;
                        document.getElementById('tokenProgress').style.width = percent + '%';
                        document.getElementById('tokenStats').style.display = 'block';
                    }
                } else {
                    document.getElementById('tokenStats').style.display = 'none';
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:', e);
                document.getElementById('tokenStats').style.display = 'none';
            }
        }
        async function loadDocs() {
            if (!user) return;
            try {
                const response = await fetch(`/api/knowledge/list?user_id=${user.id}`);
                if (!response.ok) throw new Error('Failed to load docs');
                const data = await response.json();
                const docsList = document.getElementById('docsList');
                docsList.innerHTML = '';
                if (data.docs && data.docs.length > 0) {
                    data.docs.forEach(doc => {
                        const item = document.createElement('div');
                        item.className = 'doc-item';
                        item.innerHTML = `<span class="doc-name" title="${doc.filename}">üìÑ ${doc.filename}</span><button class="doc-delete" data-id="${doc.id}">‚úï</button>`;
                        docsList.appendChild(item);
                    });
                    document.querySelectorAll('.doc-delete').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.target.dataset.id;
                            if (confirm(t('delete_confirm'))) {
                                await fetch(`/api/knowledge/delete/${id}`, { method:'DELETE' });
                                showToast(t('delete_success'), 'success');
                                loadDocs();
                            }
                        });
                    });
                    document.getElementById('docsSection').style.display = 'block';
                } else {
                    docsList.innerHTML = '<div style="padding:8px; text-align:center; color:#999;">' + (currentLang==='ru'?'–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤':'No documents') + '</div>';
                    document.getElementById('docsSection').style.display = 'block';
                }
            } catch(e){ console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:', e); }
        }
        document.getElementById('docUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('user_id', user.id);
            formData.append('file', file);
            try {
                const response = await fetch('/api/knowledge/upload', { method:'POST', body:formData });
                if (!response.ok) throw new Error('Upload failed');
                showToast(t('upload_success'), 'success');
                e.target.value = '';
                loadDocs();
            } catch(err){ showToast(t('upload_error') + ': ' + err.message, 'error'); }
        });
        function renderMessage(text) {
            const parts = []; let lastIndex = 0, match;
            const regex = /```(\w*)\n([\s\S]*?)```/g;
            while ((match = regex.exec(text)) !== null) {
                if (match.index > lastIndex) parts.push({ type:'text', content:text.substring(lastIndex, match.index) });
                parts.push({ type:'code', language:match[1]||'plaintext', code:match[2] });
                lastIndex = match.index + match[0].length;
            }
            if (lastIndex < text.length) parts.push({ type:'text', content:text.substring(lastIndex) });
            return parts;
        }
        function addMessage(text, sender, saveToHistory = true) {
            const messagesDiv = document.getElementById('messages');
            const wrapper = document.createElement('div'); wrapper.className = `message-wrapper ${sender}`;
            const avatar = document.createElement('div'); avatar.className = `avatar ${sender==='assistant'?'bot':''}`;
            if (sender === 'user') {
                avatar.textContent = (window.userName && window.userName.trim()) ? window.userName.trim().charAt(0).toUpperCase() : 'üë§';
            } else avatar.textContent = 'ü§ñ';
            wrapper.appendChild(avatar);
            const messageDiv = document.createElement('div'); messageDiv.className = `message ${sender}`;
            const parts = sender==='assistant' ? renderMessage(text) : [{ type:'text', content:text }];
            for (const part of parts) {
                if (part.type === 'text') {
                    messageDiv.appendChild(document.createTextNode(part.content));
                } else {
                    const pre = document.createElement('pre');
                    const codeElem = document.createElement('code');
                    codeElem.className = `language-${part.language}`;
                    codeElem.textContent = part.code;
                    pre.appendChild(codeElem);
                    messageDiv.appendChild(pre);
                }
            }
            const timestamp = document.createElement('div'); timestamp.className = 'timestamp';
            timestamp.textContent = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
            messageDiv.appendChild(timestamp);
            wrapper.appendChild(messageDiv);
            if (sender === 'assistant') {
                const copyBtn = document.createElement('button'); copyBtn.className = 'copy-btn'; copyBtn.textContent = 'üìã';
                copyBtn.addEventListener('click', ()=>{
                    navigator.clipboard.writeText(text).then(()=>{ copyBtn.textContent='‚úÖ'; setTimeout(()=> copyBtn.textContent='üìã', 1500); })
                    .catch(()=> showToast(t('copy_error'), 'error'));
                });
                wrapper.appendChild(copyBtn);
            }
            messagesDiv.appendChild(wrapper);
            if (sender === 'assistant') {
                const reactionsDiv = document.createElement('div'); reactionsDiv.className = 'reactions';
                reactionsDiv.innerHTML = '<button class="reaction-btn" data-reaction="like">üëç<span class="reaction-count">0</span></button><button class="reaction-btn" data-reaction="dislike">üëé<span class="reaction-count">0</span></button>';
                wrapper.appendChild(reactionsDiv);
                reactionsDiv.querySelectorAll('.reaction-btn').forEach(btn => btn.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    const countSpan = btn.querySelector('.reaction-count');
                    countSpan.textContent = parseInt(countSpan.textContent)+1;
                }));
            }
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            if (saveToHistory && user && user.id) {
                fetch('/api/chat/save', { method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({ user_id:user.id, role:sender, content:text }) }).catch(e=>console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', e));
            }
        }
        function showTyping() {
            const messagesDiv = document.getElementById('messages');
            const typingDiv = document.createElement('div'); typingDiv.className = 'message-wrapper assistant'; typingDiv.id = 'typing-indicator';
            const avatar = document.createElement('div'); avatar.className = 'avatar bot'; avatar.textContent = 'ü§ñ';
            const indicator = document.createElement('div'); indicator.className = 'typing-indicator';
            for (let i=0;i<3;i++) indicator.appendChild(document.createElement('span'));
            typingDiv.appendChild(avatar); typingDiv.appendChild(indicator);
            messagesDiv.appendChild(typingDiv); messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        function hideTyping() { document.getElementById('typing-indicator')?.remove(); }
        async function sendQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question) return;
            const model = document.getElementById('modelSelect').value;
            addMessage(question, 'user');
            input.value = ''; document.getElementById('sendBtn').disabled = true;
            showTyping();
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('active');
            const progressFill = document.getElementById('progressBarFill');
            progressFill.style.animation = 'none';
            progressFill.offsetHeight;
            progressFill.style.animation = 'progress 30s linear forwards';
            try {
                const response = await fetch('/api/ai/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, model })
                });
                hideTyping();
                progressBar.classList.remove('active');
                if (!response.ok) throw new Error('AI request failed');
                const data = await response.json();
                addMessage(data.answer, 'assistant');
            } catch (e) {
                hideTyping();
                progressBar.classList.remove('active');
                addMessage('–û—à–∏–±–∫–∞: ' + e.message, 'assistant');
            } finally {
                document.getElementById('sendBtn').disabled = false;
            }
        }
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU'; recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = ()=>{ document.getElementById('micBtn').classList.add('listening'); document.getElementById('micBtn').textContent = '‚è∫Ô∏è'; };
            recognition.onend = ()=>{ document.getElementById('micBtn').classList.remove('listening'); document.getElementById('micBtn').textContent = 'üé§'; };
            recognition.onresult = (event)=>{ document.getElementById('questionInput').value = event.results[0][0].transcript; sendQuestion(); };
            recognition.onerror = (event)=>{ console.error(event.error); document.getElementById('micBtn').classList.remove('listening'); document.getElementById('micBtn').textContent = 'üé§'; if (event.error==='not-allowed') showToast(t('mic_denied'), 'error'); };
        } else console.warn('Speech recognition not supported');
        document.getElementById('micBtn').addEventListener('click', ()=>{
            if (!recognition) { showToast(t('mic_not_supported'), 'warning'); return; }
            try { recognition.start(); } catch(e){ console.error(e); }
        });
        loadProfile();
        document.getElementById('sendBtn').addEventListener('click', sendQuestion);
        document.getElementById('questionInput').addEventListener('keypress', (e)=> e.key==='Enter' && sendQuestion());
        document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('messages').innerHTML=''; addMessage('–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ó–∞–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.','assistant'); });
        // –¢–µ–º—ã
        const themes = ['system', 'light', 'dark']; let currentThemeIndex = 0;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            const idx = themes.indexOf(savedTheme);
            if (idx !== -1) { currentThemeIndex = idx; applyTheme(savedTheme); }
        }
        function applyTheme(theme) {
            document.body.className = theme === 'system' ? '' : `theme-${theme}`;
            localStorage.setItem('theme', theme);
            const btn = document.getElementById('themeToggle');
            if (btn) {
                if (theme === 'system') btn.textContent = 'üåì';
                else if (theme === 'light') btn.textContent = '‚òÄÔ∏è';
                else btn.textContent = 'üåô';
            }
        }
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(themes[currentThemeIndex]);
        });
        // –¢–æ—Å—Ç—ã
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer') || (()=>{
                const c = document.createElement('div'); c.id='toastContainer'; c.className='toast-container';
                document.body.appendChild(c); return c;
            })();
            const toast = document.createElement('div'); toast.className = `toast ${type}`;
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'warning') icon = '‚ö†Ô∏è';
            toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span><button class="toast-close">‚úï</button>`;
            toast.querySelector('.toast-close').onclick = () => { toast.classList.add('fade-out'); setTimeout(()=>toast.remove(),300); };
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) { toast.classList.add('fade-out'); setTimeout(()=>toast.remove(),300); } }, duration);
        }
        // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –≥—Ä–∞—Ñ–∏–∫–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
        let isAdmin = false;
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const target = tab.dataset.tab;
                document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                document.getElementById(target + 'Section').classList.add('active');
            });
        });
        async function loadAdminStats() {
            try {
                const response = await fetch('/api/admin/stats', { headers: { 'Authorization': 'Bearer ' + initData } });
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                document.getElementById('totalUsers').textContent = data.total_users || 0;
                document.getElementById('activeSubs').textContent = data.active_subscriptions || 0;
                document.getElementById('totalAI').textContent = data.total_ai_requests || 0;
                document.getElementById('totalKeys').textContent = data.total_api_keys || 0;
            } catch (e) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error'); }
        }
        async function loadAdminUsers() {
            try {
                const response = await fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + initData } });
                if (!response.ok) throw new Error('Failed to load users');
                const data = await response.json();
                const tbody = document.getElementById('usersList');
                tbody.innerHTML = '';
                data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.email || '‚Äî'}</td>
                        <td>${u.role || 'user'}</td>
                        <td>${u.is_active ? '‚úÖ' : '‚ùå'}</td>
                        <td>
                            <button class="${u.is_active ? 'block-btn' : 'unblock-btn'}" data-id="${u.id}">
                                ${u.is_active ? (currentLang==='ru'?'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'Block') : (currentLang==='ru'?'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å':'Unblock')}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.querySelectorAll('#usersList button').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.id;
                        const isActive = e.target.classList.contains('unblock-btn');
                        await toggleUserBlock(userId, !isActive);
                    });
                });
            } catch (e) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error'); }
        }
        async function toggleUserBlock(userId, block) {
            try {
                const response = await fetch('/api/admin/users/' + userId + '/block', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + initData },
                    body: JSON.stringify({ is_active: !block })
                });
                if (!response.ok) throw new Error('Failed');
                showToast(block ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
                loadAdminUsers();
            } catch (e) { showToast('–û—à–∏–±–∫–∞', 'error'); }
        }
        async function loadAdminPlans() {
            try {
                const response = await fetch('/api/admin/plans', { headers: { 'Authorization': 'Bearer ' + initData } });
                if (!response.ok) throw new Error('Failed to load plans');
                const data = await response.json();
                const list = document.getElementById('plansList');
                list.innerHTML = '';
                const createBtn = document.createElement('div');
                createBtn.style.marginBottom = '16px';
                createBtn.innerHTML = '<button class="upload-btn" onclick="openCreatePlan()">‚ûï ' + (currentLang==='ru'?'–°–æ–∑–¥–∞—Ç—å —Ç–∞—Ä–∏—Ñ':'Create plan') + '</button>';
                list.appendChild(createBtn);
                data.plans.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'plan-item';
                    div.innerHTML = `
                        <div class="plan-info">
                            <h4>${p.name}</h4>
                            <p>${p.description || ''} | ${p.price_monthly} ‚ÇΩ/–º–µ—Å | AI: ${p.ai_quota}</p>
                        </div>
                        <div class="plan-actions">
                            <button class="edit-plan" data-id="${p.id}" style="background:#4caf50;">‚úèÔ∏è</button>
                            <button class="delete-plan" data-id="${p.id}">üóëÔ∏è</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                document.querySelectorAll('.edit-plan').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const planId = e.target.dataset.id;
                        const plan = data.plans.find(p => p.id == planId);
                        if (plan) openEditPlan(plan);
                    });
                });
                document.querySelectorAll('.delete-plan').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const planId = e.target.dataset.id;
                        if (confirm(currentLang==='ru'?'–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?':'Delete plan?')) {
                            try {
                                const response = await fetch('/api/admin/plans/' + planId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + initData } });
                                if (!response.ok) throw new Error('Failed');
                                showToast(currentLang==='ru'?'–¢–∞—Ä–∏—Ñ —É–¥–∞–ª—ë–Ω':'Plan deleted', 'success');
                                loadAdminPlans();
                            } catch (e) { showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error'); }
                        }
                    });
                });
            } catch (e) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤', 'error'); }
        }
        function openCreatePlan() {
            editingPlanId = null;
            document.getElementById('modalTitle').textContent = currentLang==='ru'?'–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞':'Create plan';
            document.getElementById('planId').value = '';
            document.getElementById('planName').value = '';
            document.getElementById('planCode').value = '';
            document.getElementById('planDescription').value = '';
            document.getElementById('planPriceMonthly').value = '';
            document.getElementById('planPriceYearly').value = '';
            document.getElementById('planCurrency').value = 'RUB';
            document.getElementById('planAIQuota').value = '1000000';
            document.getElementById('planAIModels').value = '*';
            document.getElementById('planIsActive').checked = true;
            document.getElementById('planModal').classList.add('active');
        }
        function openEditPlan(plan) {
            editingPlanId = plan.id;
            document.getElementById('modalTitle').textContent = currentLang==='ru'?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞':'Edit plan';
            document.getElementById('planId').value = plan.id;
            document.getElementById('planName').value = plan.name;
            document.getElementById('planCode').value = plan.code;
            document.getElementById('planDescription').value = plan.description || '';
            document.getElementById('planPriceMonthly').value = plan.price_monthly;
            document.getElementById('planPriceYearly').value = plan.price_yearly;
            document.getElementById('planCurrency').value = plan.currency;
            document.getElementById('planAIQuota').value = plan.ai_quota;
            document.getElementById('planAIModels').value = plan.ai_models ? plan.ai_models.join(',') : '*';
            document.getElementById('planIsActive').checked = plan.is_active;
            document.getElementById('planModal').classList.add('active');
        }
        document.getElementById('cancelPlanBtn').addEventListener('click', () => {
            document.getElementById('planModal').classList.remove('active');
        });
        document.getElementById('savePlanBtn').addEventListener('click', async () => {
            const planData = {
                name: document.getElementById('planName').value,
                code: document.getElementById('planCode').value,
                description: document.getElementById('planDescription').value,
                price_monthly: parseFloat(document.getElementById('planPriceMonthly').value),
                price_yearly: parseFloat(document.getElementById('planPriceYearly').value),
                currency: document.getElementById('planCurrency').value,
                ai_quota: parseInt(document.getElementById('planAIQuota').value),
                ai_models: document.getElementById('planAIModels').value.split(',').map(s => s.trim()),
                is_active: document.getElementById('planIsActive').checked,
            };
            const method = editingPlanId ? 'PUT' : 'POST';
            const url = editingPlanId ? `/api/admin/plans/${editingPlanId}` : '/api/admin/plans';
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + initData },
                    body: JSON.stringify(planData)
                });
                if (!response.ok) throw new Error('Failed to save plan');
                showToast(currentLang==='ru'?'–¢–∞—Ä–∏—Ñ —Å–æ—Ö—Ä–∞–Ω—ë–Ω':'Plan saved', 'success');
                document.getElementById('planModal').classList.remove('active');
                loadAdminPlans();
            } catch (e) { showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error'); }
        });
        // –ì—Ä–∞—Ñ–∏–∫
        function generateDemoData(period) {
            const labels = []; const data = [];
            const now = new Date();
            let days = 7;
            if (period === 'month') days = 30;
            if (period === 'year') days = 365;
            for (let i = days-1; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('ru-RU', { day:'numeric', month:'short' }));
                data.push(Math.floor(Math.random()*900)+100);
            }
            return { labels, data };
        }
        function updateChart(period) {
            const { labels, data } = generateDemoData(period);
            if (tokenChart) tokenChart.destroy();
            const ctx = document.getElementById('tokenChart').getContext('2d');
            tokenChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentLang==='ru'?'–¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ':'Tokens used',
                        data: data,
                        borderColor: '#2481cc',
                        backgroundColor: 'rgba(36,129,204,0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        document.querySelectorAll('.stats-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.stats-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateChart(btn.dataset.period);
            });
        });
        document.getElementById('adminPanelBtn')?.addEventListener('click', () => {
            const panel = document.getElementById('adminPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadAdminStats();
                loadAdminUsers();
                loadAdminPlans();
            } else {
                panel.style.display = 'none';
            }
        });
        // Pull-to-refresh
        let startY=0; window.addEventListener('touchstart', e=>{ if (window.scrollY===0) startY=e.touches[0].clientY; });
        window.addEventListener('touchmove', e=>{ if (startY>0 && e.touches[0].clientY > startY+50) { location.reload(); startY=0; } });
        // Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/app/service-worker.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW error', err));
        }
    </script>
</body>
</html>